{% if session.access_level == 'documents_only' %}
    {% extends "base_restricted.html" %}
{% else %}
    {% extends "base.html" %}
{% endif %}

{% block title %}My Documents{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            {% if current_user_role == 'admin' and user_id != session.user_id %}
                Documents for {{ user.name or user.email }}
            {% else %}
                My Documents
            {% endif %}
        </h1>
        <div>
            {% if current_user_role == 'admin' %}
                <span class="badge bg-warning">Admin View</span>
                <a href="{{ url_for('admin_documents') }}" class="btn btn-outline-primary ms-2">
                    <i class="fas fa-arrow-left"></i> Back to Admin
                </a>
            {% else %}
                <span class="badge bg-info">Technician</span>
            {% endif %}
        </div>
    </div>

    <!-- Upload Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Upload New Document</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('upload_document', user_id=user_id) }}" enctype="multipart/form-data">
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="document" class="form-label">Select Files</label>
                            <input type="file" class="form-control" id="document" name="document" 
                                   accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif" multiple required>
                            <div class="form-text">Select multiple files: PDF, DOC, DOCX, TXT, JPG, PNG, GIF (Max 10MB each)</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="document_type" class="form-label">Document Type</label>
                            <select class="form-select" id="document_type" name="document_type">
                                <option value="certification">Certification</option>
                                <option value="training">Training Record</option>
                                <option value="inspection">Inspection Report</option>
                                <option value="manual">Manual/Guide</option>
                                <option value="photo">Photo</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-upload"></i> Upload Document
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Documents List -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">
                Your Documents ({{ documents|length }})
                {% if current_user_role == 'admin' and documents %}
                    <button class="btn btn-outline-success btn-sm float-end" onclick="selectAllForBundle()">
                        Add All to Bundle
                    </button>
                {% endif %}
            </h5>
        </div>
        <div class="card-body">
            {% if documents %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                {% if current_user_role == 'admin' %}
                                <th width="50">
                                    <input type="checkbox" id="selectAllDocs" onchange="toggleAllDocuments()">
                                </th>
                                {% endif %}
                                <th>Document Name</th>
                                <th>Type</th>
                                <th>Upload Date</th>
                                <th>Size</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for doc in documents %}
                            <tr>
                                {% if current_user_role == 'admin' %}
                                <td>
                                    <input type="checkbox" class="doc-checkbox" 
                                           value="{{ doc.id }}" 
                                           data-name="{{ doc.original_name }}" 
                                           data-user="{{ user.name or user.email }}"
                                           onchange="updateBundleSelection()">
                                </td>
                                {% endif %}
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1">
                                            <div id="doc-name-display-{{ doc.id }}" class="document-name-display">
                                                <strong>{{ doc.original_name }}</strong>
                                            </div>
                                            <div id="doc-name-edit-{{ doc.id }}" class="document-name-edit" style="display: none;">
                                                <div class="input-group input-group-sm">
                                                    <input type="text" class="form-control" id="doc-name-input-{{ doc.id }}" 
                                                           value="{{ doc.original_name }}" maxlength="255">
                                                    <button class="btn btn-sm btn-success" onclick="saveDocumentName({{ doc.id }})">
                                                        <i class="bi bi-check"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-secondary" onclick="cancelEditDocumentName({{ doc.id }})">
                                                        <i class="bi bi-x"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            {% if doc.document_type %}
                                                <br><small class="text-muted">{{ doc.document_type|title }}</small>
                                            {% endif %}
                                        </div>
                                        <button class="btn btn-sm btn-outline-secondary ms-2" 
                                                onclick="editDocumentName({{ doc.id }})" 
                                                id="edit-btn-{{ doc.id }}"
                                                title="Edit document name">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ doc.document_type|title }}</span>
                                </td>
                                <td>
                                    {{ doc.uploaded_at.strftime('%m/%d/%Y %I:%M %p') if doc.uploaded_at else 'Unknown' }}
                                </td>
                                <td>
                                    {% if doc.file_size %}
                                        {{ "%.1f"|format(doc.file_size / 1024) }} KB
                                    {% else %}
                                        Unknown
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{{ url_for('download_document', doc_id=doc.id) }}" 
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-download"></i> Download
                                        </a>
                                        <button class="btn btn-sm btn-outline-danger" 
                                                onclick="deleteDocument({{ doc.id }}, '{{ doc.original_name }}')">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                    <h5>No Documents Uploaded</h5>
                    <p class="text-muted">Use the upload form above to add your first document.</p>
                </div>
            {% endif %}
        </div>
    </div>

    {% if current_user_role == 'admin' and documents %}
    <!-- Bundle Creation (Admin Only) -->
    <div id="bundleSection" class="card mt-4" style="display: none;">
        <div class="card-header">
            <h5 class="card-title mb-0">Create Bundle with Selected Documents</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('create_bundle') }}">
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label for="bundle_name" class="form-label">Bundle Name</label>
                            <input type="text" class="form-control" id="user_bundle_name_input" name="bundle_name">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-success w-100" id="createBundleBtn">
                                <i class="fas fa-file-pdf"></i> Create Bundle
                            </button>
                        </div>
                    </div>
                </div>
                <div id="selectedDocuments"></div>
            </form>
        </div>
    </div>
    {% endif %}
</div>

<script>
function deleteDocument(docId, docName) {
    if (confirm(`Are you sure you want to delete "${docName}"? This action cannot be undone.`)) {
        fetch(`/documents/delete/${docId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting document: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error deleting document: ' + error);
        });
    }
}

{% if current_user_role == 'admin' %}
function toggleAllDocuments() {
    const selectAll = document.getElementById('selectAllDocs');
    const checkboxes = document.querySelectorAll('.doc-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
    
    updateBundleSelection();
}

function updateBundleSelection() {
    const checkboxes = document.querySelectorAll('.doc-checkbox:checked');
    const bundleSection = document.getElementById('bundleSection');
    const selectedDocuments = document.getElementById('selectedDocuments');
    const createBtn = document.getElementById('createBundleBtn');
    
    if (checkboxes.length > 0) {
        bundleSection.style.display = 'block';
        
        // Add hidden inputs for selected documents
        selectedDocuments.innerHTML = '';
        checkboxes.forEach(checkbox => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'selected_documents';
            input.value = checkbox.value;
            selectedDocuments.appendChild(input);
        });
        
        createBtn.innerHTML = `<i class="fas fa-file-pdf"></i> Create Bundle (${checkboxes.length} docs)`;
    } else {
        bundleSection.style.display = 'none';
    }
}

function selectAllForBundle() {
    const selectAll = document.getElementById('selectAllDocs');
    const checkboxes = document.querySelectorAll('.doc-checkbox');
    
    selectAll.checked = true;
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
    
    updateBundleSelection();
}

// Set default bundle name with current date and user info
document.addEventListener('DOMContentLoaded', function() {
    const bundleNameInput = document.getElementById('user_bundle_name_input');
    if (bundleNameInput) {
        const userName = '{{ user.name|replace(" ", "_") if user.name else user.email.split("@")[0] }}';
        let dateStr;
        
        if (typeof moment !== 'undefined') {
            dateStr = moment().format('YYYYMMDD');
        } else {
            const today = new Date();
            dateStr = today.getFullYear() + 
                     String(today.getMonth() + 1).padStart(2, '0') + 
                     String(today.getDate()).padStart(2, '0');
        }
        
        bundleNameInput.value = 'Documents_' + userName + '_' + dateStr;
    }
});
{% endif %}

// Document renaming functions
function editDocumentName(docId) {
    const displayElement = document.getElementById(`doc-name-display-${docId}`);
    const editElement = document.getElementById(`doc-name-edit-${docId}`);
    const editButton = document.getElementById(`edit-btn-${docId}`);
    
    displayElement.style.display = 'none';
    editElement.style.display = 'block';
    editButton.style.display = 'none';
    
    // Focus on input and select filename part (without extension)
    const input = document.getElementById(`doc-name-input-${docId}`);
    input.focus();
    
    const filename = input.value;
    const lastDotIndex = filename.lastIndexOf('.');
    if (lastDotIndex > 0) {
        input.setSelectionRange(0, lastDotIndex);
    } else {
        input.select();
    }
}

function cancelEditDocumentName(docId) {
    const displayElement = document.getElementById(`doc-name-display-${docId}`);
    const editElement = document.getElementById(`doc-name-edit-${docId}`);
    const editButton = document.getElementById(`edit-btn-${docId}`);
    const input = document.getElementById(`doc-name-input-${docId}`);
    
    // Reset input to original value
    const originalName = displayElement.querySelector('strong').textContent;
    input.value = originalName;
    
    displayElement.style.display = 'block';
    editElement.style.display = 'none';
    editButton.style.display = 'block';
}

function saveDocumentName(docId) {
    const input = document.getElementById(`doc-name-input-${docId}`);
    const newName = input.value.trim();
    
    if (!newName) {
        alert('Document name cannot be empty');
        return;
    }
    
    // Show loading state
    const saveButton = document.querySelector(`#doc-name-edit-${docId} .btn-success`);
    const originalSaveText = saveButton.innerHTML;
    saveButton.innerHTML = '<i class="spinner-border spinner-border-sm"></i>';
    saveButton.disabled = true;
    
    fetch(`/api/documents/rename/${docId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            new_name: newName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the display with the new name
            const displayElement = document.getElementById(`doc-name-display-${docId}`);
            displayElement.querySelector('strong').textContent = data.new_name;
            
            // Show success message briefly
            const displayDiv = displayElement.parentElement;
            const successMsg = document.createElement('small');
            successMsg.className = 'text-success';
            successMsg.innerHTML = '<i class="bi bi-check-circle"></i> Renamed successfully';
            displayDiv.appendChild(successMsg);
            
            setTimeout(() => {
                if (successMsg.parentNode) {
                    successMsg.parentNode.removeChild(successMsg);
                }
            }, 3000);
            
            cancelEditDocumentName(docId);
        } else {
            alert('Error renaming document: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error renaming document: ' + error);
    })
    .finally(() => {
        // Restore button state
        saveButton.innerHTML = originalSaveText;
        saveButton.disabled = false;
    });
}

// Handle Enter key for saving and Escape key for canceling
document.addEventListener('keydown', function(event) {
    if (event.target.matches('[id^="doc-name-input-"]')) {
        const docId = event.target.id.split('-')[3];
        
        if (event.key === 'Enter') {
            event.preventDefault();
            saveDocumentName(docId);
        } else if (event.key === 'Escape') {
            event.preventDefault();
            cancelEditDocumentName(docId);
        }
    }
});
</script>
{% endblock %}