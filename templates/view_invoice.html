{% extends "base.html" %}

{% block title %}Invoice {{ invoice.invoice_number }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Action Bar -->
            <div class="d-flex justify-content-between align-items-center mb-4 no-print">
                <h2><i class="bi bi-receipt"></i> Invoice {{ invoice.invoice_number }}</h2>
                <div class="btn-group" role="group">
                    <a href="{{ url_for('invoices_list') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Invoices
                    </a>
                    <button type="button" class="btn btn-primary" onclick="window.print()">
                        <i class="bi bi-printer"></i> Print
                    </button>
                    <a href="{{ url_for('download_invoice_pdf', invoice_id=invoice.invoice_id) }}" class="btn btn-success">
                        <i class="bi bi-download"></i> Download PDF
                    </a>
                    {% if invoice.status == 'DRAFT' %}
                    <div class="btn-group">
                        <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="bi bi-gear"></i> Actions
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <form method="POST" action="{{ url_for('update_invoice_status_route', invoice_id=invoice.invoice_id) }}" style="display: inline;">
                                    <input type="hidden" name="status" value="SENT">
                                    <button type="submit" class="dropdown-item">
                                        <i class="bi bi-send"></i> Mark as Sent
                                    </button>
                                </form>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <form method="POST" action="{{ url_for('delete_invoice_route', invoice_id=invoice.invoice_id) }}" 
                                      onsubmit="return confirm('Are you sure you want to delete this invoice?')" style="display: inline;">
                                    <button type="submit" class="dropdown-item text-danger">
                                        <i class="bi bi-trash"></i> Delete Invoice
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </div>
                    {% elif invoice.status == 'SENT' %}
                    <form method="POST" action="{{ url_for('update_invoice_status_route', invoice_id=invoice.invoice_id) }}" style="display: inline;">
                        <input type="hidden" name="status" value="PAID">
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle"></i> Mark as Paid
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>

            <!-- Invoice Document -->
            <div class="card invoice-document">
                <div class="card-body p-5">
                    <!-- Header -->
                    <div class="row mb-5">
                        <div class="col-md-6">
                            <h1 class="display-4 fw-bold text-primary">INVOICE</h1>
                            <h3 class="text-muted">{{ invoice.invoice_number }}</h3>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="mb-2">
                                <span class="badge bg-{{ 'success' if invoice.status == 'PAID' else ('primary' if invoice.status == 'SENT' else 'secondary') }} fs-6">
                                    {{ invoice.status }}
                                </span>
                            </div>
                            <p class="mb-1"><strong>Invoice Date:</strong> {{ invoice.invoice_date.strftime('%B %d, %Y') if invoice.invoice_date else 'N/A' }}</p>
                            {% if invoice.job_number %}
                            <p class="mb-0"><strong>Job Number:</strong> {{ invoice.job_number }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Billing Information -->
                    <div class="row mb-5">
                        <div class="col-md-6">
                            <div class="border p-3 h-100">
                                <h5 class="fw-bold mb-3 text-primary">Bill To:</h5>
                                {% if invoice.issued_to_name %}
                                <p class="mb-1 fw-semibold">{{ invoice.issued_to_name }}</p>
                                {% endif %}
                                {% if invoice.issued_to_company %}
                                <p class="mb-1">{{ invoice.issued_to_company }}</p>
                                {% endif %}
                                {% if invoice.issued_to_address %}
                                <p class="mb-0">{{ invoice.issued_to_address | replace('\n', '<br>') | safe }}</p>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border p-3 h-100">
                                <h5 class="fw-bold mb-3 text-primary">Pay To:</h5>
                                {% if invoice.pay_to_name %}
                                <p class="mb-1 fw-semibold">{{ invoice.pay_to_name }}</p>
                                {% endif %}
                                {% if invoice.pay_to_company %}
                                <p class="mb-1">{{ invoice.pay_to_company }}</p>
                                {% endif %}
                                {% if invoice.pay_to_address %}
                                <p class="mb-0">{{ invoice.pay_to_address | replace('\n', '<br>') | safe }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Equipment Context (if applicable) -->
                    {% if invoice.equipment_id %}
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <h6 class="alert-heading mb-2">
                                    <i class="bi bi-gear"></i> Equipment Context
                                </h6>
                                <p class="mb-0">
                                    <strong>Equipment ID:</strong> {{ invoice.equipment_id }}
                                    {% if invoice.equipment_name %}
                                    | <strong>Name:</strong> {{ invoice.equipment_name }}
                                    {% endif %}
                                    {% if invoice.equipment_type %}
                                    | <strong>Type:</strong> {{ invoice.equipment_type }}
                                    {% endif %}
                                    {% if invoice.customer_name and invoice.job_title %}
                                    <br><strong>Job:</strong> {{ invoice.customer_name }} - {{ invoice.job_title }}
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Line Items -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead class="table-primary">
                                        <tr>
                                            <th>Description</th>
                                            <th class="text-end">Unit Price</th>
                                            <th class="text-center">Quantity</th>
                                            <th class="text-end">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in invoice.line_items %}
                                        <tr>
                                            <td>{{ item.description }}</td>
                                            <td class="text-end">${{ "%.2f"|format(item.unit_price) }}</td>
                                            <td class="text-center">{{ item.quantity }}</td>
                                            <td class="text-end">${{ "%.2f"|format(item.line_total) }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Totals -->
                    <div class="row">
                        <div class="col-md-8"></div>
                        <div class="col-md-4">
                            <div class="border p-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Subtotal:</span>
                                    <span>${{ "%.2f"|format(invoice.subtotal or 0) }}</span>
                                </div>
                                {% if invoice.tax_rate and invoice.tax_rate > 0 %}
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Tax ({{ "%.1f"|format(invoice.tax_rate) }}%):</span>
                                    <span>${{ "%.2f"|format(invoice.tax_amount or 0) }}</span>
                                </div>
                                {% endif %}
                                <hr>
                                <div class="d-flex justify-content-between fw-bold fs-5">
                                    <span>Total:</span>
                                    <span>${{ "%.2f"|format(invoice.total_amount or 0) }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
@media print {
    .no-print {
        display: none !important;
    }
    
    .invoice-document {
        border: none !important;
        box-shadow: none !important;
    }
    
    .card-body {
        padding: 0 !important;
    }
    
    body {
        background: white !important;
    }
}

.invoice-document {
    background: white;
    margin-bottom: 2rem;
}
</style>
{% endblock %}