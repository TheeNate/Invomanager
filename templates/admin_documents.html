{% extends "base.html" %}

{% block title %}Document Management - Admin{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Document Management</h1>
        <div>
            <span class="badge bg-info">Admin View</span>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Total Technicians</h5>
                    <h2 class="text-primary">{{ technicians|length }}</h2>
                    <p class="card-text text-muted">Active users with document access</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Total Documents</h5>
                    <h2 class="text-success">{{ technicians|sum(attribute='document_count') }}</h2>
                    <p class="card-text text-muted">Documents across all users</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Document Bundle Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Create Document Bundle</h5>
        </div>
        <div class="card-body">
            <form id="bundleForm" method="POST" action="{{ url_for('create_bundle') }}">
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label for="bundle_name" class="form-label">Bundle Name</label>
                            <input type="text" class="form-control" id="bundle_name_input" name="bundle_name" 
                                   placeholder="Enter bundle name...">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-success w-100" id="createBundleBtn" disabled>
                                <i class="fas fa-file-pdf"></i> Create Bundle
                            </button>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <p class="text-muted">Select documents below to include in the bundle. The bundle will create a PDF summary with document details.</p>
                </div>
            </form>
        </div>
    </div>

    <!-- Admin Document Upload -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-cloud-upload-alt"></i> Admin Document Upload
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <form action="{{ url_for('upload_document', user_id=session.user_id) }}" method="post" enctype="multipart/form-data">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="adminDocument" class="form-label">Select Documents</label>
                                    <input type="file" class="form-control" id="adminDocument" name="document" 
                                           accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif" multiple required>
                                    <div class="form-text">Select multiple files: PDF, DOC, DOCX, TXT, JPG, PNG, GIF (max 10MB each)</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="adminDocType" class="form-label">Document Type</label>
                                    <select class="form-select" id="adminDocType" name="document_type">
                                        <option value="policy">Policy/Procedure</option>
                                        <option value="manual">Manual/Guide</option>
                                        <option value="certificate">Certificate</option>
                                        <option value="training">Training Material</option>
                                        <option value="report">Report</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="submit" class="form-control btn btn-primary">
                                        <i class="fas fa-upload"></i> Upload
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="col-md-4">
                    <div class="bg-light p-3 rounded">
                        <h6 class="mb-2"><i class="fas fa-info-circle"></i> Admin Documents</h6>
                        <p class="small mb-1">Upload documents that you want to manage centrally as an administrator.</p>
                        <p class="small mb-0 text-muted">These will appear in your technician list for bundling and management.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Technicians and Documents -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Technicians & Documents</h5>
            <div>
                <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#inviteTechModal">
                    <i class="fas fa-user-plus"></i> Invite Tech
                </button>
                <button class="btn btn-outline-primary btn-sm" onclick="selectAll()">Select All</button>
                <button class="btn btn-outline-secondary btn-sm" onclick="selectNone()">Select None</button>
            </div>
        </div>
        <div class="card-body">
            {% if technicians %}
                {% for technician in technicians %}
                <div class="technician-section mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">
                            <i class="fas fa-user"></i>
                            {{ technician.name or technician.email }}
                            {% if technician.role == 'admin' %}
                                <span class="badge bg-primary ms-2">Admin</span>
                            {% endif %}
                            <span class="badge bg-secondary ms-2">{{ technician.document_count }} docs</span>
                        </h6>
                        <div>
                            {% if technician.document_count > 0 %}
                                <button class="btn btn-sm btn-outline-info me-2" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#docs-{{ technician.id }}" 
                                        aria-expanded="false">
                                    <i class="fas fa-chevron-down"></i> Expand Documents
                                </button>
                            {% endif %}
                            <a href="{{ url_for('user_documents', user_id=technician.id) }}" 
                               class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-folder-open"></i> View Documents
                            </a>
                        </div>
                    </div>
                    
                    {% if technician.document_count > 0 %}
                    <div class="collapse" id="docs-{{ technician.id }}">
                        <div class="documents-list mt-3 ps-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">Select documents for bundle:</small>
                                <div>
                                    <button class="btn btn-xs btn-outline-primary" onclick="selectUserDocs({{ technician.id }}, true)">
                                        <i class="fas fa-check-square"></i> Select All
                                    </button>
                                    <button class="btn btn-xs btn-outline-secondary ms-1" onclick="selectUserDocs({{ technician.id }}, false)">
                                        <i class="fas fa-square"></i> Select None
                                    </button>
                                </div>
                            </div>
                            <div id="user-docs-{{ technician.id }}" class="loading-docs">
                                <div class="text-center p-3">
                                    <i class="fas fa-spinner fa-spin"></i> Loading documents...
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-muted ps-3 mt-2">
                        <small><i class="fas fa-info-circle"></i> No documents uploaded yet</small>
                    </div>
                    {% endif %}
                </div>
                
                {% if not loop.last %}
                <hr>
                {% endif %}
                {% endfor %}
            {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <h5>No Technicians Found</h5>
                    <p class="text-muted">No technician users have been created yet.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Selected Documents Display (will be populated by JavaScript) -->
    <div id="selectedDocuments" class="card mt-4" style="display: none;">
        <div class="card-header">
            <h5 class="card-title mb-0">Selected Documents for Bundle</h5>
        </div>
        <div class="card-body" id="selectedDocsList">
            <!-- Selected documents will be listed here -->
        </div>
    </div>
</div>

<script>
let selectedDocuments = [];

function selectAll() {
    // This would select all documents if we had them loaded
    // For now, just show message
    alert('Use the "View Documents" links to select individual documents for bundling.');
}

function selectNone() {
    selectedDocuments = [];
    updateSelectedDocuments();
    updateBundleButton();
}

function toggleDocument(docId, docName, userName) {
    const index = selectedDocuments.findIndex(doc => doc.id === docId);
    
    if (index > -1) {
        selectedDocuments.splice(index, 1);
    } else {
        selectedDocuments.push({id: docId, name: docName, user: userName});
    }
    
    updateSelectedDocuments();
    updateBundleButton();
}

function updateSelectedDocuments() {
    const container = document.getElementById('selectedDocuments');
    const list = document.getElementById('selectedDocsList');
    
    if (selectedDocuments.length === 0) {
        container.style.display = 'none';
        return;
    }
    
    container.style.display = 'block';
    
    let html = '<div class="row">';
    selectedDocuments.forEach(doc => {
        html += `
            <div class="col-md-6 mb-2">
                <div class="d-flex justify-content-between align-items-center bg-light p-2 rounded">
                    <div>
                        <strong>${doc.name}</strong><br>
                        <small class="text-muted">User: ${doc.user}</small>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="toggleDocument(${doc.id}, '${doc.name}', '${doc.user}')">
                        Remove
                    </button>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    list.innerHTML = html;
}

function updateBundleButton() {
    const btn = document.getElementById('createBundleBtn');
    btn.disabled = selectedDocuments.length === 0;
    btn.innerHTML = selectedDocuments.length > 0 
        ? `<i class="fas fa-file-pdf"></i> Create Bundle (${selectedDocuments.length} docs)`
        : '<i class="fas fa-file-pdf"></i> Create Bundle';
}

// Handle form submission
document.getElementById('bundleForm').addEventListener('submit', function(e) {
    if (selectedDocuments.length === 0) {
        e.preventDefault();
        alert('Please select at least one document for the bundle.');
        return;
    }
    
    // Add hidden inputs for selected documents
    selectedDocuments.forEach(doc => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'selected_documents';
        input.value = doc.id;
        this.appendChild(input);
    });
});

// Load documents for a specific user
function loadUserDocuments(userId) {
    const container = document.getElementById(`user-docs-${userId}`);
    
    fetch(`/api/user/${userId}/documents`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                let html = '';
                if (data.documents.length === 0) {
                    html = '<div class="text-muted p-2"><small>No documents uploaded yet</small></div>';
                } else {
                    data.documents.forEach(doc => {
                        const isSelected = selectedDocuments.some(selectedDoc => selectedDoc.id === doc.id);
                        const sizeStr = doc.file_size ? `${(doc.file_size / 1024).toFixed(1)} KB` : 'Unknown';
                        
                        html += `
                            <div class="form-check border rounded p-2 mb-2 ${isSelected ? 'bg-light' : ''}">
                                <input class="form-check-input" type="checkbox" id="doc-${doc.id}" 
                                       ${isSelected ? 'checked' : ''}
                                       onchange="toggleDocument(${doc.id}, '${doc.original_name.replace(/'/g, "\\'")}', '${data.user_name.replace(/'/g, "\\'")}')">
                                <label class="form-check-label w-100" for="doc-${doc.id}">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <strong>${doc.original_name}</strong><br>
                                            <small class="text-muted">
                                                Type: ${doc.document_type.charAt(0).toUpperCase() + doc.document_type.slice(1)} | 
                                                Size: ${sizeStr} | 
                                                Uploaded: ${doc.uploaded_at}
                                            </small>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        `;
                    });
                }
                container.innerHTML = html;
            } else {
                container.innerHTML = `<div class="text-danger p-2">Error loading documents: ${data.message}</div>`;
            }
        })
        .catch(error => {
            container.innerHTML = `<div class="text-danger p-2">Error loading documents: ${error.message}</div>`;
        });
}

// Handle collapse events to load documents
document.addEventListener('shown.bs.collapse', function(event) {
    const collapseId = event.target.id;
    if (collapseId.startsWith('docs-')) {
        const userId = collapseId.split('-')[1];
        loadUserDocuments(userId);
    }
});

// Update expand button icon
document.addEventListener('shown.bs.collapse', function(event) {
    const button = document.querySelector(`[data-bs-target="#${event.target.id}"]`);
    if (button) {
        button.innerHTML = '<i class="fas fa-chevron-up"></i> Collapse Documents';
    }
});

document.addEventListener('hidden.bs.collapse', function(event) {
    const button = document.querySelector(`[data-bs-target="#${event.target.id}"]`);
    if (button) {
        button.innerHTML = '<i class="fas fa-chevron-down"></i> Expand Documents';
    }
});

// Select/deselect all documents for a user
function selectUserDocs(userId, selectAll) {
    const checkboxes = document.querySelectorAll(`#user-docs-${userId} input[type="checkbox"]`);
    checkboxes.forEach(checkbox => {
        const docId = parseInt(checkbox.id.split('-')[1]);
        const isCurrentlySelected = selectedDocuments.some(doc => doc.id === docId);
        
        if (selectAll && !isCurrentlySelected) {
            checkbox.checked = true;
            checkbox.dispatchEvent(new Event('change'));
        } else if (!selectAll && isCurrentlySelected) {
            checkbox.checked = false;
            checkbox.dispatchEvent(new Event('change'));
        }
    });
}

// Initialize
updateBundleButton();

// Set default bundle name with current date
document.addEventListener('DOMContentLoaded', function() {
    const bundleNameInput = document.getElementById('bundle_name_input');
    if (bundleNameInput) {
        const today = new Date();
        const dateStr = today.getFullYear() + 
                       String(today.getMonth() + 1).padStart(2, '0') + 
                       String(today.getDate()).padStart(2, '0');
        bundleNameInput.value = 'Document_Package_' + dateStr;
    }
});
</script>

<!-- Invite Technician Modal -->
<div class="modal fade" id="inviteTechModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Invite New Technician</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="inviteTechForm" method="POST" action="{{ url_for('invite_technician') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="techEmail" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="techEmail" name="email" required>
                        <div class="form-text">The technician will receive an email with a link to access their document upload area.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Access Level</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="access_level" id="accessFull" value="full">
                            <label class="form-check-label" for="accessFull">
                                <strong>Full Access</strong> - Can access entire system including equipment management
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="access_level" id="accessDocs" value="documents_only" checked>
                            <label class="form-check-label" for="accessDocs">
                                <strong>Documents Only</strong> - Restricted to document upload area only
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-paper-plane"></i> Send Invite
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Handle invite form submission
document.getElementById('inviteTechForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const email = document.getElementById('techEmail').value;
    const accessLevel = document.querySelector('input[name="access_level"]:checked').value;
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    // Show loading state
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
    submitBtn.disabled = true;
    
    // Submit form
    fetch(this.action, {
        method: 'POST',
        body: new FormData(this)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('inviteTechModal')).hide();
            
            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="bi bi-check-circle"></i> Invitation sent successfully to ${email}!
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            // Insert alert above the form
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild); 
            
            // Clear form
            this.reset();
            document.getElementById('accessDocs').checked = true;
            
            // Refresh to show new technician (if they already have an account)
            setTimeout(() => location.reload(), 2000);
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while sending the invite.');
    })
    .finally(() => {
        // Reset button
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});
</script>
{% endblock %}